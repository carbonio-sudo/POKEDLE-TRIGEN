{% extends 'base.html' %}

{% block titulo %} PokeDle {% endblock titulo %}

{% block conteudo %}

<div id="game-page">

    <div id="game-background"></div>

    <h1 id="game-title" class="text-center mt-3 fw-bold">Pokémon Wordle</h1>

    <h3 id="score-display" class="text-center mt-2">
        Pontos: <b>{{ pontos }}</b>
    </h3>

    <form id="guess-form" method="POST" class="text-center mt-4">

        <div class="autocomplete-wrapper">
            <input type="text" id="poke-input" class="game-input" name="guess"
            placeholder="Digite um Pokémon" autocomplete="off" required>
            <div id="autocomplete-box"></div>
            <button type="submit" id="send-button" class="btn btn-primary mt-2">Enviar</button>
        </div>
    </form>

    <form id="reset-form" action="/reset" method="POST" class="text-center mt-3">
        <button id="reset-button" class="btn btn-danger">Resetar Tentativas</button>
    </form>

    <p id="game-message" class="text-center fs-4 mt-3">
        {{ message }}
    </p>

    <div id="table-header" class="container mt-4">
        <div class="row text-center fw-bold">
            <div class="col">Icone</div>
            <div class="col">Tipo 1</div>
            <div class="col">Tipo 2</div>
            <div class="col">Habitat</div>
            <div class="col">Cor</div>
            <div class="col">Fase</div>
            <div class="col">Altura</div>
            <div class="col">Peso</div>
        </div>
    </div>

    <div id="attempts-box" class="container">
        {% for row in attempts %}
        <div class="row text-center mt-2 game-row">
            <div class="col">
                <img src="{{ row.sprite }}" width="64">
            </div>
            <div class="col cell {{ row.tipo1_cor }}">{{ row.tipo1 }}</div>
            <div class="col cell {{ row.tipo2_cor }}">{{ row.tipo2 }}</div>
            <div class="col cell {{ row.habitat_cor }}">{{ row.habitat }}</div>
            <div class="col cell {{ row.cor_cor }}">{{ row.cor }}</div>
            <div class="col cell {{ row.fase_cor }}">{{ row.fase }}</div>
            <div class="col cell {{ row.altura_cor }}">{{ row.altura }}</div>
            <div class="col cell {{ row.peso_cor }}">{{ row.peso }}</div>
        </div>
        {% endfor %}
    </div>

    {% if session.venceu %}
    <div id="tela-vitoria">
        <div class="vitoria-box">
            <h1>Parabéns!</h1>
            <p>Você acertou: <b>{{ alvo }}</b></p>
            <p>Pontuação final: <b>{{ pontos }}</b></p>

            <form action="/reset" method="POST">
                <button class="btn btn-success mt-3">Jogar Novamente</button>
            </form>
        </div>
    </div>
    {% endif %}

</div>



<script>
const lista = {{ pokemon_list | tojson }};
const input = document.getElementById("poke-input");
const box = document.getElementById("autocomplete-box");

let index = -1;
let sugestoes = [];

// -------- AUTOCOMPLETE --------
input.addEventListener("input", () => {
    const t = input.value.toLowerCase();
    box.innerHTML = "";
    box.style.display = "none";
    index = -1;

    if (!t) return;

    sugestoes = lista.filter(n => n.toLowerCase().startsWith(t)).slice(0, 10);

    if (!sugestoes.length) return;

    sugestoes.forEach((nome) => {
        const div = document.createElement("div");
        div.className = "suggestion";
        div.textContent = nome;

        div.onclick = () => {
            input.value = nome;
            box.innerHTML = "";
            box.style.display = "none";
        };

        box.appendChild(div);
    });

    box.style.display = "block";
});

// -------- SETAS DO TECLADO --------
input.addEventListener("keydown", (e) => {
    const items = box.querySelectorAll(".suggestion");
    if (!items.length) return;

    if (e.key === "ArrowDown") {
        e.preventDefault();
        index = (index + 1) % items.length;
    } 
    else if (e.key === "ArrowUp") {
        e.preventDefault();
        index = (index - 1 + items.length) % items.length;
    } 
    else if (e.key === "Enter") {
        if (index >= 0) {
            e.preventDefault();
            input.value = sugestoes[index];
            box.innerHTML = "";
            box.style.display = "none";
        }
        return;
    }

    items.forEach((item, i) => {
        item.classList.toggle("active", i === index);
    });
});

// -------- FECHAR AUTOCOMPLETE AO CLICAR FORA --------
document.addEventListener("click", (e) => {
    if (!e.target.closest(".autocomplete-wrapper")) {
        box.innerHTML = "";
        box.style.display = "none";
    }
});
</script>

{% endblock conteudo %}
